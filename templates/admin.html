<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Arial', sans-serif;
      padding-top: 70px; /* for fixed navbar space */
    }

    .container {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      animation: fadeIn 1s ease-in-out;
      max-width: 95%;
      overflow-x: auto;
      height: 80vh;
      margin-bottom: 20px;
      position: relative;
    }

    h2 {
      color: #0ea5e9;
      border-bottom: 2px solid #0ea5e9;
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .btn {
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(14, 165, 233, 0.3);
    }

    .btn-outline-warning {
      color: #ffc107;
      border-color: #ffc107;
    }

    .btn-outline-warning:hover {
      background-color: #ffc107;
      color: #121212;
    }

    .table {
      color: #e0e0e0;
    }

    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #1a1a1a;
    }

    .table-hover tbody tr:hover {
      background-color: #2c2c2c;
    }

    thead {
      background-color: #0ea5e9;
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .loader-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: calc(80vh - 60px);
    }

    .loader {
      border: 8px solid #303030;
      border-top: 8px solid #0ea5e9;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    .user-count {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 0.85em;
      color: #0ea5e9;
      background-color: #1e1e1e;
      padding: 6px 12px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.2);
      font-weight: 500;
    }

    .modal-content {
      background-color: #222;
      color: #ddd;
      border: none;
      border-radius: 10px;
    }

    .modal-header,
    .modal-footer {
      border: none;
    }

    .form-control {
      background-color: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
    }

    .form-control:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.25);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 576px) {
      .container {
        padding: 10px;
      }
      .user-count {
        font-size: 0.75em;
        padding: 5px 10px;
        top: 5px;
        right: 5px;
      }
    }

    html {
  scroll-behavior: smooth;
}


    #loginScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #f8f9fa;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #loginCard {
      width: 100%;
      max-width: 400px;
      padding: 2rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      background-color: white;
    }

    .dashboard {
      display: none;
      padding: 20px;
    }

    #logoutBtn {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .fade-in {
      animation: fadeIn 0.6s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }


  </style>
</head>
<body>
    <!-- Login Screen -->
  <div id="loginScreen">
    <div id="loginCard" class="fade-in">
      <h4 class="text-center mb-4">Admin Login</h4>
      <form id="adminLoginForm">
        <div class="mb-3">
          <input type="email" class="form-control" id="adminEmail" placeholder="Email" required>
        </div>
        <div class="mb-3">
          <input type="password" class="form-control" id="adminPassword" placeholder="Password" required>
        </div>
        <div id="loginError" class="text-danger mb-2" style="display:none;"></div>
        <button type="submit" class="btn btn-primary w-100">Login</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <a class="navbar-brand" href="#"><i class="fas fa-user-shield"></i> Admin Panel</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href="#dashboardSection"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#activeInvestmentsSection"><i class="fas fa-chart-line"></i> Active Investments</a>
      </li>
    </ul>
  </div>
</nav>

    <button class="btn btn-outline-warning mt-4" data-toggle="modal" data-target="#changePasswordModal">
  <i class="fas fa-key"></i> Change User Password
</button>
<button class="btn btn-primary btn-sm edit-balance"
    data-email="${user.email}"
    data-usdt-trc="${user.usdt_trc_balance}"
    data-btc="${user.btc_balance}"
    data-eth="${user.eth_balance}"
    data-usdt-erc="${user.usdt_erc_balance}">
    <i class="fas fa-edit"></i> Edit Balances
</button>

   <div class="container mt-5 pt-5" id="dashboardSection">

        <h2 class="mb-4">Admin Dashboard</h2>
        <div class="user-count">Total Users: <span id="totalUsers">0</span></div>
        <div class="loader-container" id="loaderContainer">
            <div class="loader" id="loader"></div>
        </div>
        <table id="userTable" class="table table-striped table-hover d-none">
            <thead style="background-color: #0ea5e9; color: white;">
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>USDT TRC Balance</th>
                    <th>BTC Balance</th>
                    <th>ETH Balance</th>
                    <th>USDT ERC Balance</th>
                    <th>Pending Deposit</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- Dynamic content will be injected here -->
            </tbody>
        </table>

<h2 class="mt-5" id="activeInvestmentsSection">Active Investments</h2>
<div class="table-responsive">
    <table class="table table-dark table-hover" id="investmentTable">
        <thead class="thead-light">
            <tr>
                <th>User ID</th>
                <th>Amount</th>
                <th>Currency</th>
                <th>Plan</th>
                <th>Return Amount</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Update</th>
            </tr>
        </thead>
        <tbody id="investmentTableBody">
            <!-- Populated dynamically -->
        </tbody>
    </table>
</div>
    </div>
    </div>

    <div class="modal fade" id="confirmApproveModal" tabindex="-1" role="dialog" aria-labelledby="confirmApproveModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmApproveModalLabel">Confirm Deposit Approval</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to approve this deposit of <span id="approveModalAmount"></span> <span id="approveModalCurrency"></span>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmApproveBtn">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm User Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this user?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change User Password (By Email)</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="adminChangePasswordForm">
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" class="form-control" id="adminUserEmail" required>
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" class="form-control" id="adminNewPassword" required>
          </div>
          <button type="submit" class="btn btn-warning btn-block">Change Password</button>
        </form>
        <div id="adminChangePasswordResult" class="text-center mt-3 font-weight-bold"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editBalanceModal" tabindex="-1" role="dialog" aria-labelledby="editBalanceModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="editBalanceForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit User Balances</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <!-- Manually Editable Email Field -->
        <div class="form-group">
          <label for="editUserEmail">User Email</label>
          <input type="email" class="form-control" id="editUserEmail" required>
        </div>

        <div class="form-group">
          <label>USDT TRC</label>
          <input type="number" step="any" class="form-control" id="editUsdtTrc">
        </div>
        <div class="form-group">
          <label>BTC</label>
          <input type="number" step="any" class="form-control" id="editBtc">
        </div>
        <div class="form-group">
          <label>ETH</label>
          <input type="number" step="any" class="form-control" id="editEth">
        </div>
        <div class="form-group">
          <label>USDT ERC</label>
          <input type="number" step="any" class="form-control" id="editUsdtErc">
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Save Changes</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        // Function to fetch and update the user count
        function updateUserCount() {
            $.ajax({
                url: '/fetch_users_count',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('User count response from server:', response);
                    if (response && response.user_count !== undefined) {
                        $('#totalUsers').text(response.user_count);
                    } else {
                        console.error('Error fetching user count.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching user count:', error);
                }
            });
        }

        // Initial fetch and display of user count
        updateUserCount();

        // Periodically fetch and update the user count every 2 seconds
        setInterval(updateUserCount, 2000);

        // Function to fetch and update the user table
        function updateUserTable() {
            $.ajax({
                url: '/fetch_users',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('User table response from server:', response);

                    if (response && response.users && response.users.length > 0) {
                        const users = response.users;
                        const $tableBody = $('#userTableBody');
                        $tableBody.empty(); // Clear existing rows
                        users.forEach(user => {
                            const $row = $(`
                                <tr>
                                    <td>${user.username}</td>
                                    <td>${user.email}</td>
                                    <td>$ ${user.usdt_trc_balance}</td>
                                    <td>$ ${user.btc_balance}</td>
                                    <td>$ ${user.eth_balance}</td>
                                    <td>$ ${user.usdt_erc_balance}</td>
                                    <td>$ ${user.pending_deposit} ${user.currency || ''}</td>
                                    <td class="action-buttons">
                                        ${user.pending_deposit > 0 ? `<button class="btn btn-success btn-sm approve-deposit" data-user-id="${user._id}" data-amount="${user.pending_deposit}" data-currency="${user.currency}"><i class="fas fa-check"></i> Approve</button>` : ''}
                                        <button class="btn btn-danger btn-sm delete-user" data-user-id="${user._id}"><i class="fas fa-trash-alt"></i> Delete</button>
                                    </td>
                                </tr>
                            `);
                            $tableBody.append($row);
                        });
                        $('#loaderContainer').hide();
                        $('#userTable').removeClass('d-none');
                    } else {
                        console.error('No users found.');
                        $('#loaderContainer').hide();
                        $('#userTableBody').append('<tr><td colspan="8">No users found.</td></tr>');
                        $('#userTable').removeClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching users:', error);
                    $('#loaderContainer').hide();
                    $('#userTableBody').append('<tr><td colspan="8">Error fetching users. Please try again later.</td></tr>');
                    $('#userTable').removeClass('d-none');
                }
            });
        }

        // Initial fetch and display of user table
        updateUserTable();

        // Periodically fetch and update the user table every 2 seconds
        setInterval(updateUserTable, 2000);

        // Event handlers for approve deposit and delete user actions
        let selectedUserId;
        let selectedAmount;
        let selectedCurrency;

        $(document).on('click', '.approve-deposit', function() {
            selectedUserId = $(this).data('user-id');
            selectedAmount = $(this).data('amount');
            selectedCurrency = $(this).data('currency');

            // Disable the approve button to prevent multiple clicks
            $(this).prop('disabled', true);

            $('#approveModalAmount').text(selectedAmount);
            $('#approveModalCurrency').text(selectedCurrency);
            $('#confirmApproveModal').modal('show');
        });

        $('#confirmApproveBtn').click(function() {
            $.ajax({
                url: `/approve_deposit/${selectedUserId}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ amount: selectedAmount, currency: selectedCurrency }),
                success: function(response) {
                    $('#confirmApproveModal').modal('hide');
                    alert('Deposit approved successfully.');
                    updateUserTable(); // Update table after approval
                },
                error: function(xhr, status, error) {
                    console.error('Error approving deposit:', error);
                    alert('Error approving deposit. Please try again.');
                },
                complete: function() {
                    // Enable the approve button again after completion (success or error)
                    $(`.approve-deposit[data-user-id="${selectedUserId}"]`).prop('disabled', false);
                }
            });
        });

        let selectedDeleteUserId;

        $(document).on('click', '.delete-user', function() {
            selectedDeleteUserId = $(this).data('user-id');
            $('#confirmDeleteModal').modal('show');
        });

        $('#confirmDeleteBtn').click(function() {
            $.ajax({
                url: `/delete_user/${selectedDeleteUserId}`,
                method: 'POST',
                success: function(response) {
                    $('#confirmDeleteModal').modal('hide');
                    alert('User deleted successfully.');
                    updateUserTable(); // Update table after deletion
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user. Please try again.');
                }
            });
        });
    });
</script>

<script>
  $('#adminChangePasswordForm').on('submit', function(e) {
    e.preventDefault();
    const email = $('#adminUserEmail').val();
    const newPassword = $('#adminNewPassword').val();

    $.ajax({
      url: '/admin/change-password',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ email: email, new_password: newPassword }),
      success: function(response) {
        $('#adminChangePasswordResult').text(response.msg).css('color', 'green');
        $('#adminChangePasswordForm')[0].reset();
      },
      error: function(xhr) {
        let error = xhr.responseJSON?.msg || 'Error occurred';
        $('#adminChangePasswordResult').text(error).css('color', 'red');
      }
    });
  });
</script>

<script>
function updateInvestmentTable() {
    $.ajax({
        url: '/admin/active-investments',
        method: 'GET',
        dataType: 'json',
        success: function(response) {
            const $tableBody = $('#investmentTableBody');
            $tableBody.empty();
            response.investments.forEach(investment => {
                const $row = $(`
                    <tr>
                        <td>${investment.user_id}</td>
                        <td>$${investment.amount.toFixed(2)}</td>
                        <td>${investment.currency}</td>
                        <td>${investment.plan}</td>
                        <td>
                            <input type="number" step="0.01" value="${investment.return_amount}" class="form-control form-control-sm return-amount-input" data-id="${investment._id}">
                        </td>
                        <td>${new Date(investment.start_date).toLocaleString()}</td>
                        <td>${new Date(investment.end_date).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-warning update-investment" data-id="${investment._id}"><i class="fas fa-sync-alt"></i> Update</button>
                        </td>
                    </tr>
                `);
                $tableBody.append($row);
            });
        },
        error: function(xhr) {
            console.error('Error fetching investments:', xhr.responseText);
        }
    });
}

$(document).on('click', '.update-investment', function() {
    const investmentId = $(this).data('id');
    const newReturn = $(`.return-amount-input[data-id="${investmentId}"]`).val();

    $.ajax({
        url: `/admin/update-investment/${investmentId}`,
        method: 'PATCH',
        contentType: 'application/json',
        data: JSON.stringify({ return_amount: parseFloat(newReturn) }),
        success: function(response) {
            alert(response.message || 'Investment updated successfully');
            updateInvestmentTable();
        },
        error: function(xhr) {
            alert(xhr.responseJSON?.message || 'Failed to update investment');
        }
    });
});

updateInvestmentTable();
setInterval(updateInvestmentTable, 3000);
</script>
 <script>
    $(document).ready(function () {
      // Check login status
      const isLoggedIn = localStorage.getItem('isLoggedIn');

      if (isLoggedIn === 'true') {
        $('#loginScreen').hide();
        $('.dashboard').show();
        $('body').css('overflow', 'auto');
      }

      $('#adminLoginForm').on('submit', function (e) {
        e.preventDefault();

        const email = $('#adminEmail').val().trim();
        const password = $('#adminPassword').val().trim();
        const errorDiv = $('#loginError');

        if (email === 'teslaproinvestmentplatform1@gmail.com' && password === 'Teslaprois4.') {
          localStorage.setItem('isLoggedIn', 'true');
          $('#loginScreen').fadeOut(400, function () {
            $('.dashboard').fadeIn();
            $('body').css('overflow', 'auto');
          });
        } else {
          errorDiv.text('Invalid credentials. Try again.').fadeIn();
        }
      });

      $('#logoutBtn').on('click', function () {
        localStorage.removeItem('isLoggedIn');
        location.reload();
      });
    });
  </script>
  <script>
  $(document).on('click', '.edit-balance', function() {
    $('#editUserEmail').val($(this).data('email'));
    $('#editUsdtTrc').val($(this).data('usdt-trc'));
    $('#editBtc').val($(this).data('btc'));
    $('#editEth').val($(this).data('eth'));
    $('#editUsdtErc').val($(this).data('usdt-erc'));
    $('#editBalanceModal').modal('show');
});

$('#editBalanceForm').on('submit', function(e) {
    e.preventDefault();
    const email = $('#editUserEmail').val();
    const data = {
        email: email,
        usdt_trc_balance: parseFloat($('#editUsdtTrc').val()),
        btc_balance: parseFloat($('#editBtc').val()),
        eth_balance: parseFloat($('#editEth').val()),
        usdt_erc_balance: parseFloat($('#editUsdtErc').val())
    };

    $.ajax({
        url: '/edit_balance_by_email',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            $('#editBalanceModal').modal('hide');
            alert('Balances updated successfully.');
            updateUserTable();
        },
        error: function(xhr, status, error) {
            alert('Error updating balances. Please try again.');
        }
    });
});

</script>

</body>
</html>
<!-- The rest of your code continues here exactly as it was... -->